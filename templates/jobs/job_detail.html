{% extends 'base.html' %}

{% block title %}{{ job.title }} - 招聘平台{% endblock %}

{% block content %}
<main class="pt-16">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-12">
        <div class="bg-white shadow rounded-lg">
            <!-- Job Header -->
            <div class="p-6 border-b border-gray-200">
                <div class="flex items-start justify-between">
                    <div>
                        <h1 class="text-3xl font-bold text-gray-900">{{ job.title }}</h1>
                        <div class="mt-2 flex items-center text-gray-500">
                            <span class="flex items-center">
                                <i class="fas fa-building mr-2"></i>
                                {{ job.employer.company_name }}
                            </span>
                            <span class="mx-4">|</span>
                            <span class="flex items-center">
                                <i class="fas fa-location-dot mr-2"></i>
                                {{ job.location }}
                            </span>
                            <span class="mx-4">|</span>
                            <span class="flex items-center">
                                <i class="fas fa-clock mr-2"></i>
                                {{ job.job_type }}
                            </span>
                        </div>
                    </div>
                    <div class="text-right">
                        <div class="text-2xl font-bold text-custom">{{ job.salary }}</div>
                        <div class="text-sm text-gray-500">发布于 {{ job.posted_date|timesince }}前</div>
                    </div>
                </div>
            </div>

            <!-- Job Content -->
            <div class="p-6 grid grid-cols-1 lg:grid-cols-3 gap-6">
                <div class="lg:col-span-2">
                    <!-- Job Description -->
                    <div class="mb-8">
                        <h2 class="text-xl font-semibold mb-4">职位描述</h2>
                        <div class="prose max-w-none">
                            {{ job.description|linebreaks }}
                        </div>
                    </div>

                    <!-- Requirements -->
                    <div class="mb-8">
                        <h2 class="text-xl font-semibold mb-4">职位要求</h2>
                        <div class="prose max-w-none">
                            {{ job.requirements|linebreaks }}
                        </div>
                    </div>
                </div>

                <!-- Application Sidebar -->
                <div class="lg:col-span-1">
                    <!-- Bookmark Button -->
                    {% if user.is_authenticated and user.is_job_seeker %}
                    <div class="mb-4">
                        <button id="bookmark-btn" 
                                data-job-id="{{ job.id }}" 
                                data-is-bookmarked="{{ is_bookmarked|yesno:'true,false' }}"
                                class="w-full flex items-center justify-center px-4 py-2 border border-gray-300 rounded-md shadow-sm text-sm font-medium transition-colors
                                       {% if is_bookmarked %}
                                       bg-yellow-50 text-yellow-700 border-yellow-300 hover:bg-yellow-100
                                       {% else %}
                                       bg-white text-gray-700 hover:bg-gray-50
                                       {% endif %}">
                            <i class="{% if is_bookmarked %}fas fa-bookmark text-yellow-500{% else %}far fa-bookmark{% endif %} mr-2"></i>
                            <span id="bookmark-text">
                                {% if is_bookmarked %}已收藏{% else %}收藏职位{% endif %}
                            </span>
                        </button>
                    </div>
                    {% endif %}
                    
                    <div class="bg-gray-50 rounded-lg p-6">
                        {% if user.is_authenticated and user.is_job_seeker %}
                            {% if has_applied %}
                                <div class="text-center">
                                    <div class="text-green-600 mb-2">
                                        <i class="fas fa-check-circle text-3xl"></i>
                                    </div>
                                    <p class="text-gray-600">您已经申请了这个职位</p>
                                </div>
                            {% else %}
                                <form method="POST" action="{% url 'jobs:apply_job' job.id %}">
                                    {% csrf_token %}
                                    {{ application_form.as_p }}
                                    <button type="submit" class="w-full bg-custom text-white rounded-md py-2 px-4 hover:bg-custom-dark transition-colors">
                                        立即申请
                                    </button>
                                </form>
                            {% endif %}
                        {% elif user.is_authenticated and user.is_employer %}
                            <p class="text-center text-gray-600">雇主不能申请职位</p>
                        {% else %}
                            <div class="text-center">
                                <p class="mb-4 text-gray-600">请登录以申请此职位</p>
                                <a href="{% url 'accounts:login' %}" class="block w-full bg-custom text-white rounded-md py-2 px-4 hover:bg-custom-dark transition-colors text-center">
                                    登录
                                </a>
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</main>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const bookmarkBtn = document.getElementById('bookmark-btn');
    
    if (bookmarkBtn) {
        bookmarkBtn.addEventListener('click', function() {
            const jobId = this.dataset.jobId;
            const isBookmarked = this.dataset.isBookmarked === 'true';
            
            // Disable button during request
            this.disabled = true;
            
            fetch(`/jobs/${jobId}/bookmark/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                    'Content-Type': 'application/json',
                },
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Update button state
                    const icon = this.querySelector('i');
                    const text = this.querySelector('#bookmark-text');
                    
                    if (data.is_bookmarked) {
                        // Now bookmarked
                        icon.className = 'fas fa-bookmark text-yellow-500 mr-2';
                        text.textContent = '已收藏';
                        this.className = this.className.replace('bg-white text-gray-700 hover:bg-gray-50', 'bg-yellow-50 text-yellow-700 border-yellow-300 hover:bg-yellow-100');
                        this.dataset.isBookmarked = 'true';
                    } else {
                        // No longer bookmarked
                        icon.className = 'far fa-bookmark mr-2';
                        text.textContent = '收藏职位';
                        this.className = this.className.replace('bg-yellow-50 text-yellow-700 border-yellow-300 hover:bg-yellow-100', 'bg-white text-gray-700 hover:bg-gray-50');
                        this.dataset.isBookmarked = 'false';
                    }
                    
                    // Show success message (optional)
                    showMessage(data.message, 'success');
                } else {
                    showMessage(data.message || '操作失败，请重试', 'error');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showMessage('网络错误，请重试', 'error');
            })
            .finally(() => {
                // Re-enable button
                this.disabled = false;
            });
        });
    }
});

function showMessage(message, type) {
    // Create a simple toast notification
    const toast = document.createElement('div');
    toast.className = `fixed top-20 right-4 px-4 py-2 rounded-md text-white z-50 ${type === 'success' ? 'bg-green-500' : 'bg-red-500'}`;
    toast.textContent = message;
    
    document.body.appendChild(toast);
    
    // Remove after 3 seconds
    setTimeout(() => {
        toast.remove();
    }, 3000);
}
</script>
{% endblock %} 