{% extends 'base.html' %}

{% block title %}设置新密码 - 招聘平台{% endblock %}

{% block content %}
<div class="min-h-screen flex items-center justify-center bg-gray-50/50 p-4 sm:p-6 lg:p-8">
    <div class="w-full max-w-md bg-white rounded-xl p-8 relative
                before:absolute before:inset-0 before:-z-10 before:rounded-xl before:p-1
                before:bg-gradient-to-r before:from-green-500 via-blue-500 to-purple-500
                before:animate-border-glow
                after:absolute after:inset-0 after:-z-10 after:rounded-xl after:bg-white">
        
        <div class="text-center mb-8">
            <h2 class="text-3xl font-bold bg-gradient-to-r from-green-600 via-blue-600 to-purple-600 
                       text-transparent bg-clip-text animate-gradient-x">
                设置新密码
            </h2>
            <p class="mt-2 text-sm text-gray-600">请输入验证码和新密码</p>
            <p class="mt-1 text-xs text-gray-500">验证码已发送到：{{ email }}</p>
        </div>

        {% if messages %}
            {% for message in messages %}
                <div class="mb-4 p-4 rounded-lg {% if message.tags == 'error' %}bg-red-100 text-red-700{% else %}bg-green-100 text-green-700{% endif %}">
                    {{ message }}
                </div>
            {% endfor %}
        {% endif %}

        <!-- Password Requirements Info -->
        <div class="mb-6 p-4 bg-blue-50 rounded-lg text-sm text-blue-700">
            <h3 class="font-medium mb-2">密码要求：</h3>
            <ul class="list-disc list-inside space-y-1">
                <li>至少8个字符</li>
                <li>必须包含至少一个大写字母</li>
                <li>必须包含至少一个数字</li>
                <li>必须包含至少一个特殊字符</li>
            </ul>
        </div>

        <form method="POST" class="space-y-6" id="password-reset-confirm-form">
            {% csrf_token %}
            
            <!-- Hidden email field -->
            {{ form.email }}
            
            <!-- Verification Code Field -->
            <div>
                <label for="{{ form.verification_code.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-1">
                    {{ form.verification_code.label }}
                </label>
                {{ form.verification_code }}
                <!-- 验证状态显示区域 -->
                <div id="verification-status" class="mt-2 text-sm hidden"></div>
                {% if form.verification_code.errors %}
                <div class="text-red-500 text-sm mt-1">
                    {{ form.verification_code.errors }}
                </div>
                {% endif %}
            </div>

            <!-- New Password Field -->
            <div>
                <label for="{{ form.new_password1.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-1">
                    {{ form.new_password1.label }}
                </label>
                {{ form.new_password1 }}
                {% if form.new_password1.errors %}
                <div class="text-red-500 text-sm mt-1">
                    {{ form.new_password1.errors }}
                </div>
                {% endif %}
            </div>

            <!-- Confirm Password Field -->
            <div>
                <label for="{{ form.new_password2.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-1">
                    {{ form.new_password2.label }}
                </label>
                {{ form.new_password2 }}
                {% if form.new_password2.errors %}
                <div class="text-red-500 text-sm mt-1">
                    {{ form.new_password2.errors }}
                </div>
                {% endif %}
            </div>

            <!-- Submit Button -->
            <button type="submit" 
                    class="w-full py-3 px-4 rounded-lg text-white text-sm font-medium
                           bg-gradient-to-r from-green-500 via-blue-500 to-purple-500
                           hover:from-green-600 hover:via-blue-600 hover:to-purple-600
                           transform hover:scale-[1.02] transition-all duration-200">
                重置密码
            </button>
        </form>

        <!-- Back to Login Link -->
        <p class="mt-6 text-center text-sm text-gray-600">
            想起密码了？ 
            <a href="{% url 'accounts:login' %}" 
               class="text-green-600 hover:text-blue-600 transition-colors hover:underline">
                返回登录
            </a>
        </p>
    </div>
</div>

<style>
    @keyframes border-glow {
        0%, 100% {
            opacity: 1;
            box-shadow: 0 0 20px rgba(34, 197, 94, 0.5),
                       0 0 30px rgba(59, 130, 246, 0.3),
                       0 0 40px rgba(147, 51, 234, 0.3);
        }
        50% {
            opacity: 0.5;
            box-shadow: 0 0 24px rgba(34, 197, 94, 0.8),
                       0 0 36px rgba(59, 130, 246, 0.6),
                       0 0 48px rgba(147, 51, 234, 0.6);
        }
    }

    @keyframes gradient-x {
        0%, 100% {
            background-size: 200% 200%;
            background-position: left center;
        }
        50% {
            background-size: 200% 200%;
            background-position: right center;
        }
    }

    .animate-border-glow {
        animation: border-glow 3s ease-in-out infinite;
    }

    .animate-gradient-x {
        animation: gradient-x 15s ease infinite;
    }
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const verificationCodeInput = document.getElementById('{{ form.verification_code.id_for_label }}');
    const newPassword1Input = document.getElementById('{{ form.new_password1.id_for_label }}');
    const newPassword2Input = document.getElementById('{{ form.new_password2.id_for_label }}');
    const passwordResetConfirmForm = document.getElementById('password-reset-confirm-form');
    const verificationStatus = document.getElementById('verification-status');
    
    let isVerifying = false;
    let isVerified = false;
    
    // 密码显示/隐藏切换功能
    document.querySelectorAll('.password-toggle').forEach(function(toggleButton) {
        toggleButton.addEventListener('click', function() {
            const targetId = this.getAttribute('data-target');
            const passwordInput = document.getElementById(targetId);
            const eyeHidden = this.querySelector('.eye-hidden');
            const eyeVisible = this.querySelector('.eye-visible');
            
            if (passwordInput.type === 'password') {
                // 显示密码
                passwordInput.type = 'text';
                eyeHidden.classList.add('hidden');
                eyeVisible.classList.remove('hidden');
            } else {
                // 隐藏密码
                passwordInput.type = 'password';
                eyeHidden.classList.remove('hidden');
                eyeVisible.classList.add('hidden');
            }
        });
    });
    
    // 自动验证验证码
    verificationCodeInput.addEventListener('input', function() {
        const code = this.value.trim();
        
        // 清除之前的验证状态
        clearVerificationStatus();
        
        // 如果输入了6位数字，自动开始验证
        if (code.length === 6 && /^\d{6}$/.test(code) && !isVerifying && !isVerified) {
            autoVerifyCode();
        } else if (code.length < 6) {
            // 清除验证状态
            clearVerificationStatus();
        }
    });
    
    // 自动验证函数
    function autoVerifyCode() {
        const email = '{{ email }}';
        const code = verificationCodeInput.value.trim();
        
        if (!email || !code) {
            showVerificationStatus('请输入邮箱和验证码', 'error');
            return;
        }
        
        if (isVerifying) return;
        
        isVerifying = true;
        showVerificationStatus('验证中...', 'info');
        
        // 发送AJAX请求验证
        fetch('{% url "accounts:verify_code" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            },
            body: `email=${encodeURIComponent(email)}&code=${encodeURIComponent(code)}`
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showVerificationStatus('✓ 验证成功', 'success');
                verificationCodeInput.classList.remove('border-red-500');
                verificationCodeInput.classList.add('border-green-500', 'bg-green-50');
                isVerified = true;
            } else {
                showVerificationStatus(data.message, 'error');
                verificationCodeInput.classList.remove('border-green-500', 'bg-green-50');
                verificationCodeInput.classList.add('border-red-500');
                isVerified = false;
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showVerificationStatus('验证失败，请稍后重试', 'error');
            verificationCodeInput.classList.remove('border-green-500', 'bg-green-50');
            verificationCodeInput.classList.add('border-red-500');
            isVerified = false;
        })
        .finally(() => {
            isVerifying = false;
        });
    }
    
    // 显示验证状态
    function showVerificationStatus(message, type) {
        verificationStatus.textContent = message;
        verificationStatus.className = `mt-2 text-sm ${
            type === 'success' ? 'text-green-600' : 
            type === 'error' ? 'text-red-600' : 
            'text-blue-600'
        }`;
        verificationStatus.classList.remove('hidden');
    }
    
    // 清除验证状态
    function clearVerificationStatus() {
        verificationStatus.classList.add('hidden');
        verificationCodeInput.classList.remove('bg-green-50', 'border-green-500', 'border-red-500');
        isVerified = false;
    }
    
    // 密码强度检查
    function checkPasswordStrength(password) {
        const requirements = {
            length: password.length >= 8,
            uppercase: /[A-Z]/.test(password),
            lowercase: /[a-z]/.test(password),
            number: /\d/.test(password),
            special: /[!@#$%^&*()_+\-=\[\]{}|;:,.<>?]/.test(password)
        };
        
        return requirements;
    }
    
    // 实时密码强度检查
    newPassword1Input.addEventListener('input', function() {
        const password = this.value;
        const requirements = checkPasswordStrength(password);
        
        // 移除之前的样式
        this.classList.remove('border-red-500', 'border-green-500', 'bg-red-50', 'bg-green-50');
        
        if (password.length > 0) {
            const allMet = Object.values(requirements).every(req => req);
            if (allMet) {
                this.classList.add('border-green-500', 'bg-green-50');
            } else {
                this.classList.add('border-red-500', 'bg-red-50');
            }
        }
    });
    
    // 确认密码检查
    newPassword2Input.addEventListener('input', function() {
        const password1 = newPassword1Input.value;
        const password2 = this.value;
        
        // 移除之前的样式
        this.classList.remove('border-red-500', 'border-green-500', 'bg-red-50', 'bg-green-50');
        
        if (password2.length > 0) {
            if (password1 === password2) {
                this.classList.add('border-green-500', 'bg-green-50');
            } else {
                this.classList.add('border-red-500', 'bg-red-50');
            }
        }
    });
    
    // 表单提交前验证
    passwordResetConfirmForm.addEventListener('submit', function(e) {
        const code = verificationCodeInput.value.trim();
        const password1 = newPassword1Input.value;
        const password2 = newPassword2Input.value;
        
        if (!code) {
            e.preventDefault();
            showMessage('请输入验证码', 'error');
            return;
        }
        
        if (code.length !== 6) {
            e.preventDefault();
            showMessage('验证码必须是6位数字', 'error');
            return;
        }
        
        // 检查验证码是否已验证
        if (!isVerified) {
            e.preventDefault();
            showMessage('请先验证邮箱验证码', 'error');
            return;
        }
        
        if (!password1) {
            e.preventDefault();
            showMessage('请输入新密码', 'error');
            return;
        }
        
        if (!password2) {
            e.preventDefault();
            showMessage('请确认新密码', 'error');
            return;
        }
        
        if (password1 !== password2) {
            e.preventDefault();
            showMessage('两次输入的密码不一致', 'error');
            return;
        }
        
        const requirements = checkPasswordStrength(password1);
        const allMet = Object.values(requirements).every(req => req);
        
        if (!allMet) {
            e.preventDefault();
            showMessage('密码不符合要求，请检查密码强度', 'error');
            return;
        }
    });
    
    // 显示消息
    function showMessage(message, type) {
        // 移除现有的消息
        const existingMessage = document.querySelector('.message-alert');
        if (existingMessage) {
            existingMessage.remove();
        }
        
        // 创建新消息
        const messageDiv = document.createElement('div');
        messageDiv.className = `message-alert p-4 rounded-lg text-sm font-medium mb-4 ${
            type === 'success' ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'
        }`;
        messageDiv.textContent = message;
        
        // 插入到表单顶部
        passwordResetConfirmForm.insertBefore(messageDiv, passwordResetConfirmForm.firstChild);
        
        // 3秒后自动移除
        setTimeout(() => {
            if (messageDiv.parentNode) {
                messageDiv.remove();
            }
        }, 3000);
    }
});
</script>
{% endblock %}
